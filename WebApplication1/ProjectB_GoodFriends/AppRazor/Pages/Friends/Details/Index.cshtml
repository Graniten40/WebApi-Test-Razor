@page "{friendId:guid}"
@using System
@using AppRazor.Models
@model AppRazor.Pages.Friends.Details.IndexModel

@{
    ViewData["Title"] = "Friend details";

    // Route-parametern heter "friendId" pga @page "{friendId:guid}".
    // Vi l√§ser ut den manuellt h√§r f√∂r att kunna √•teranv√§nda guid:en i l√§nkar/formul√§r.
    var fidStr = RouteData.Values["friendId"]?.ToString();

     // S√§ker parsing: om n√•got blir fel landar vi i Guid.Empty och stoppar renderingen l√§ngre ner.
    var fid = Guid.TryParse(fidStr, out var g) ? g : Guid.Empty;
}

@* Visar tempor√§ra "flash"-meddelanden (ex: efter lyckad delete/add) *@
@if (!string.IsNullOrWhiteSpace(Model.FlashMessage))
{
    <div class="alert alert-success">@Model.FlashMessage</div>
}

@* Visar felmeddelanden fr√•n PageModel (ex: om API-anrop misslyckas) *@
@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger"><pre class="mb-0">@Model.ErrorMessage</pre></div>
}

@* Guard clauses: om route eller data √§r fel vill vi inte f√∂rs√∂ka rendera resten av sidan *@
@if (fid == Guid.Empty)
{
    <div class="alert alert-danger">Invalid friendId in route.</div>
    return;
}

@if (Model.Friend == null)
{
    <div class="alert alert-warning">Friend not found.</div>
    return;
}

<h2>@Model.Friend.Name</h2>
<p><strong>Email:</strong> @Model.Friend.Email</p>

<div class="mb-3">
    @* Navigerar till Edit-sidan och skickar med id som route-parametern "id" *@
    <a class="btn btn-primary"
       asp-page="/Friends/Edit"
       asp-route-id="@fid">
        Edit friend
    </a>

    <a class="btn btn-outline-secondary" asp-page="/Friends/Index">Back</a>
</div>

@if (Model.Friend.Birthday != null)
{
    <p><strong>Birthday:</strong> @Model.Friend.Birthday.Value.ToShortDateString()</p>
}

@* Debug/info-rad: hj√§lper vid fels√∂kning och visar att relationerna laddats *@
<p class="text-muted">
    <small>
        FriendId: @fid |
        Pets: @(Model.Friend.Pets?.Count ?? 0) |
        Quotes: @(Model.Friend.Quotes?.Count ?? 0)
    </small>
</p>

<hr />

<h4>üìç Address</h4>
@if (Model.Friend.Address != null)
{
    <p>
        @Model.Friend.Address.StreetAddress<br />
        @Model.Friend.Address.ZipCode @Model.Friend.Address.City, @Model.Friend.Address.Country
    </p>
}
else
{
    <em>No address</em>
}

<hr />

<!-- ADD PET -->
<h4 class="mt-3">Add pet</h4>
@* Formul√§r som POST:ar till handler-metoden OnPostAddPetAsync i PageModel *@
<form method="post"
      asp-page-handler="AddPet"
      asp-route-friendId="@fid"
      novalidate
      class="row g-2 mb-4">
    @Html.AntiForgeryToken()

    @* Input kopplat till NewPet i PageModel (BindProperty) *@
    <div class="col-md-4">
        <label class="form-label">Name</label>
        <input class="form-control" asp-for="NewPet.Name" />
        <span class="text-danger" asp-validation-for="NewPet.Name"></span>
    </div>

    @* Enum-dropdown (PetKind) *@
    <div class="col-md-3">
        <label class="form-label">Kind</label>
        <select class="form-select"
                asp-for="NewPet.Kind"
                asp-items="Html.GetEnumSelectList<AppRazor.Models.PetKind>()">
        </select>
        <span class="text-danger" asp-validation-for="NewPet.Kind"></span>
    </div>

    @* Enum-dropdown (PetMood) *@
    <div class="col-md-3">
        <label class="form-label">Mood</label>
        <select class="form-select"
                asp-for="NewPet.Mood"
                asp-items="Html.GetEnumSelectList<PetMood>()">
        </select>
        <span class="text-danger" asp-validation-for="NewPet.Mood"></span>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-success w-100" type="submit">Add</button>
    </div>
</form>

<h4>üê∂ Pets</h4>
@if (Model.Friend.Pets?.Any() == true)
{
    <ul class="list-group mb-4">
        @foreach (var pet in Model.Friend.Pets)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>@pet.Name</strong>

                    @if (!string.IsNullOrWhiteSpace(pet.StrKind))
                    {
                        <span>(@pet.StrKind)</span>
                    }
                    else
                    {
                        <span>(Kind: @pet.Kind)</span>
                    }

                    @if (!string.IsNullOrWhiteSpace(pet.StrMood))
                    {
                        <span class="text-muted"> ‚Äì @pet.StrMood</span>
                    }
                    else
                    {
                        <span class="text-muted"> ‚Äì Mood: @pet.Mood</span>
                    }
                </div>

                @* Delete-knappen √∂ppnar en Bootstrap-modal och skickar med data-* attribut
                   som JS anv√§nder f√∂r att fylla hidden input i modalens formul√§r. *@
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deletePetModal"
                        data-pet-id="@pet.PetId"
                        data-pet-name="@pet.Name">
                    Delete
                </button>
            </li>
        }
    </ul>
}
else
{
    <em>No pets</em>
}

<hr />

<!-- ADD QUOTE -->
<h4 class="mt-3">Add quote</h4>
@* Formul√§r som POST:ar till handler-metoden OnPostAddQuoteAsync *@
<form method="post"
      asp-page-handler="AddQuote"
      asp-route-friendId="@fid"
      novalidate
      class="row g-2 mb-4">
    @Html.AntiForgeryToken()

    <div class="col-md-8">
        <label class="form-label">Text</label>
        <input class="form-control" asp-for="NewQuote.Text" />
        <span class="text-danger" asp-validation-for="NewQuote.Text"></span>
    </div>

    <div class="col-md-3">
        <label class="form-label">Author</label>
        <input class="form-control" asp-for="NewQuote.Author" />
        <span class="text-danger" asp-validation-for="NewQuote.Author"></span>
    </div>

    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-success w-100" type="submit">Add</button>
    </div>
</form>

<h4>üí¨ Quotes</h4>
@if (Model.Friend.Quotes?.Any() == true)
{
    <ul class="list-group mb-4">
        @foreach (var q in Model.Friend.Quotes)
        {
            var text = (q.Text ?? "").Trim();
            var author = string.IsNullOrWhiteSpace(q.Author) ? "Unknown" : q.Author;
            var shortText = text.Length > 160 ? text.Substring(0, 160) + "‚Ä¶" : text;

            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="me-3">
                    @if (string.IsNullOrWhiteSpace(text))
                    {
                        <em>(no quote text)</em> <span class="text-muted">‚Äî @author</span>
                    }
                    else
                    {
                        <span>‚Äú@shortText‚Äù</span> <span class="text-muted">‚Äî @author</span>
                    }
                </div>

                 @* √ñppnar quote-modal och skickar med id + text via data-* *@
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteQuoteModal"
                        data-quote-id="@q.QuoteId"
                        data-quote-text="@(string.IsNullOrWhiteSpace(text) ? "(no text)" : text)">
                    Delete
                </button>
            </li>
        }
    </ul>
}
else
{
    <em>No quotes</em>
}

<!-- Delete Pet Modal -->
@* Modal med ett POST-formul√§r som anropar OnPostDeletePetAsync
   Hidden input fylls av JavaScript n√§r modalen √∂ppnas *@
<div class="modal fade" id="deletePetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirm delete pet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete <strong id="petToDeleteName"></strong>?
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

                <form method="post"
                      asp-page-handler="DeletePet"
                      asp-route-friendId="@fid">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="petId" id="petToDeleteId" />
                    <button type="submit" class="btn btn-danger">Yes, delete</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Delete Quote Modal -->
@* Samma m√∂nster som f√∂r pets: modal + hidden input + POST till DeleteQuote *@
<div class="modal fade" id="deleteQuoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirm delete quote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete this quote?
                <div class="mt-2 p-2 bg-light border rounded" id="quoteToDeleteText"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

                <form method="post"
                      asp-page-handler="DeleteQuote"
                      asp-route-friendId="@fid">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="quoteId" id="quoteToDeleteId" />
                    <button type="submit" class="btn btn-danger">Yes, delete</button>
                </form>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // N√§r pet-modalen √∂ppnas: h√§mta data fr√•n knappen och fyll hidden input + namntext.
        const petModal = document.getElementById('deletePetModal');
        if (petModal) {
            petModal.addEventListener('show.bs.modal', function (event) {
                const btn = event.relatedTarget;
                if (!btn) return;

                const petId = btn.getAttribute('data-pet-id');
                const petName = btn.getAttribute('data-pet-name') || '';

                document.getElementById('petToDeleteId').value = petId;
                document.getElementById('petToDeleteName').textContent = petName;
            });
        }

        // N√§r quote-modalen √∂ppnas: fyll hidden input + visa en (ev. kortad) preview av citatet.
        const quoteModal = document.getElementById('deleteQuoteModal');
        if (quoteModal) {
            quoteModal.addEventListener('show.bs.modal', function (event) {
                const btn = event.relatedTarget;
                if (!btn) return;

                const quoteId = btn.getAttribute('data-quote-id');
                const quoteText = btn.getAttribute('data-quote-text') || '';

                document.getElementById('quoteToDeleteId').value = quoteId;

                const clean = quoteText.trim();
                document.getElementById('quoteToDeleteText').textContent =
                    clean.length > 300 ? clean.substring(0, 300) + '‚Ä¶' : clean;
            });
        }
    </script>
}
