@page "{friendId:guid}"
@model AppRazor.Pages.Friends.DetailsModel

@* Visar namn om Friend är laddad (null-safe med ?. ) *@
<h2>@Model.Friend?.Name</h2>

@* FlashMessage kommer från TempData efter redirect (t.ex. efter delete) *@
@if (!string.IsNullOrWhiteSpace(Model.FlashMessage))
{
    <div class="alert alert-success">@Model.FlashMessage</div>
}

@* ErrorMessage används för att visa fel vid t.ex. API-problem *@
@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<hr />

<h4>Pets</h4>

@if (Model.Friend?.Pets?.Any() == true)
{
    <ul class="list-group mb-4">
        @foreach (var pet in Model.Friend.Pets)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>@pet.Name</strong>
                </div>

                @* Delete-knappen öppnar Bootstrap-modal och skickar med data via data-* attribut.
                   JavaScript läser dessa när modalen visas och fyller hidden inputs i formuläret. *@
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deletePetModal"
                        data-pet-id="@pet.PetId"
                        data-pet-name="@pet.Name">
                    Delete
                </button>
            </li>
        }
    </ul>
}
else
{
    <p class="text-muted">No pets.</p>
}

<h4>Quotes</h4>

@if (Model.Friend?.Quotes?.Any() == true)
{
    <ul class="list-group mb-4">
        @foreach (var q in Model.Friend.Quotes)
        {
            var text = q.Text ?? "";
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="me-3">
                    <span>@text</span>
                </div>

                 @* Samma modal-mönster som för pets, men med quoteId + quoteText *@
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteQuoteModal"
                        data-quote-id="@q.QuoteId"
                        data-quote-text="@(string.IsNullOrWhiteSpace(text) ? "(no text)" : text)">
                    Delete
                </button>
            </li>
        }
    </ul>
}
else
{
    <p class="text-muted">No quotes.</p>
}

<!-- Delete Pet Modal -->
@* Modal confirmation: användaren måste bekräfta innan vi skickar POST.
   PetId sätts via JS till hidden input när modalen öppnas. *@
<div class="modal fade" id="deletePetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirm delete pet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete <strong id="petToDeleteName"></strong>?
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

                @* POST till handlern DeletePet (OnPostDeletePetAsync i PageModel) *@
                <form method="post" asp-page-handler="DeletePet">
                    @Html.AntiForgeryToken()

                    @* friendId skickas med så servern kan redirecta tillbaka till rätt friend *@
                    <input type="hidden" name="friendId" value="@(Model.Friend?.FriendId ?? Guid.Empty)" />

                    @* petId fylls av JS när modalen öppnas *@
                    <input type="hidden" name="petId" id="petToDeleteId" />

                    <button type="submit" class="btn btn-danger">Yes, delete</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Delete Quote Modal -->
<div class="modal fade" id="deleteQuoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirm delete quote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete this quote?
                @* Visar en preview av texten så användaren vet vad som tas bort *@
                <div class="mt-2 p-2 bg-light border rounded" id="quoteToDeleteText"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

                @* POST till handlern DeleteQuote (OnPostDeleteQuoteAsync i PageModel) *@
                <form method="post" asp-page-handler="DeleteQuote">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="friendId" value="@(Model.Friend?.FriendId ?? Guid.Empty)" />
                    <input type="hidden" name="quoteId" id="quoteToDeleteId" />

                    <button type="submit" class="btn btn-danger">Yes, delete</button>
                </form>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        // När pet-modalen öppnas: läs data från knappen och fyll hidden input + visningsnamn.
        const petModal = document.getElementById('deletePetModal');
        petModal?.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;
            const petId = btn.getAttribute('data-pet-id');
            const petName = btn.getAttribute('data-pet-name') || '';

            document.getElementById('petToDeleteId').value = petId;
            document.getElementById('petToDeleteName').textContent = petName;
        });
        
        // När quote-modalen öppnas: fyll hidden input + en kort preview av quoteText.
        const quoteModal = document.getElementById('deleteQuoteModal');
        quoteModal?.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;
            const quoteId = btn.getAttribute('data-quote-id');
            const quoteText = (btn.getAttribute('data-quote-text') || '').trim();

            document.getElementById('quoteToDeleteId').value = quoteId;
            document.getElementById('quoteToDeleteText').textContent =
                quoteText.length > 140 ? quoteText.substring(0, 140) + '…' : quoteText;
        });
    </script>
}
